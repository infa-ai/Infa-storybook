<!-- 358a4346-5c2f-480e-b10d-01dd66528f84 f81ca715-8179-4506-9970-93bcc1aa78d0 -->
# Usage Panel Data Integration Plan

## Overview

Implement Infa API integration for the Usage panel to fetch and display main component titles based on story parameters, using build-time data injection for security.

## Key Decisions Based on Research

**Story Parameters (Storybook 9):**

- Use standard Storybook 9 parameters API: `parameters: { usage: { mcComponentIds: [...] } }`
- Panel accesses via `useParameter('usage', defaultValue)` hook
- Supports array of IDs - users can connect multiple main components to one story

**Data Storage:**

- Centralized `src/data/usage-data.json` file (standard addon pattern)
- Format: `{ [mcComponentId]: { title: string } }`
- Simple, single source of truth, easy bulk fetching

**Integration Script:**

- `scripts/infa-integration.js` is separate from the addon (not published)
- Optional example users can adapt for their needs
- Addon itself is data-source-agnostic

## Implementation Steps

### 1. Query Supabase Database Structure

Use Supabase MCP to:

- Query main_components table schema
- Identify ID format (UUID vs text)
- Confirm title field name
- Test with board: https://infa.ai/open?board=b_fWZUZj9v&componentView=cv_jhQiEhlh

### 2. Create Supabase RPC Function

Using Supabase MCP, create:

- Function: `get_storybook_main_components`
- Input: `p_mc_component_ids` (array of UUIDs or text)
- Returns: `TABLE(id TEXT, title TEXT)`
- Include auth validation

Example SQL:

```sql
CREATE OR REPLACE FUNCTION get_storybook_main_components(p_mc_component_ids UUID[])
RETURNS TABLE(id UUID, title TEXT) AS $$
BEGIN
  RETURN QUERY
  SELECT mc.id, mc.title
  FROM main_components mc
  WHERE mc.id = ANY(p_mc_component_ids);
END;
$$ LANGUAGE plpgsql;
```

### 3. Create Infa Integration Example Script

Create `scripts/infa-integration.js` (NOT part of addon package):

- Read `INFA_API_KEY` from environment (test key: 7f314d05eb03f036b7fe19f4c13ba5bbfba4a27767e43192ca03a7e7390b5da8)
- Scan story files for `parameters.usage.mcComponentIds`
- Call API: `POST https://api.infa.ai/rest/v1/rpc/get_storybook_main_components`
- Headers: apikey and Authorization Bearer
- Generate `src/data/usage-data.json`

### 4. Update Types

Modify `src/types.ts`:

- Remove old `Result` interface
- Add `UsageParameters` interface: `{ mcComponentIds: string[] }`
- Add `ComponentData` interface: `{ title: string }`
- Add `UsageDataMap` type: `Record<string, ComponentData>`

### 5. Rewrite Panel Component

Modify `src/components/Panel.tsx`:

- Remove all TabsState and demo content
- Import `useParameter` from `storybook/manager-api`
- Read `mcComponentIds` from parameters: `useParameter('usage', { mcComponentIds: [] })`
- Import usage-data.json (with fallback to empty object)
- Map over mcComponentIds and display titles
- Show empty state when no IDs configured
- Simple, clean UI

### 6. Create Mock Data

Create `src/data/usage-data.json`:

```json
{
  "example-uuid-1": { "title": "Primary Button" },
  "example-uuid-2": { "title": "Secondary Button" }
}
```

Create `src/data/.gitkeep` to keep directory in git.

### 7. Simplify withRoundTrip

Modify `src/withRoundTrip.ts`:

- Remove DOM analysis code (no longer needed)
- Keep as minimal placeholder for future features
- Or remove entirely if not needed

### 8. Update Documentation

Modify `README.md`:

- Document mcComponentIds array parameter for Storybook 9
- Show example story configuration with multiple IDs
- Explain data format for usage-data.json
- Document optional Infa integration script separately
- Provide clear instructions for custom integrations

Example:

```typescript
// Button.stories.tsx
export default {
  component: Button,
  parameters: {
    usage: {
      mcComponentIds: ['uuid-1', 'uuid-2']
    }
  }
}
```

## Files Modified

**New:**

- `scripts/infa-integration.js` - Example script (not published)
- `src/data/usage-data.json` - Mock/generated data
- `src/data/.gitkeep`

**Modified:**

- `src/types.ts` - New interfaces
- `src/components/Panel.tsx` - Complete rewrite
- `src/withRoundTrip.ts` - Simplify/remove
- `README.md` - Usage documentation
- `.gitignore` - Add auto-generated data if needed

**Supabase (via MCP):**

- Query main_components schema
- Create RPC function

## Testing Plan

1. Create mock data with example IDs
2. Update demo stories with usage parameters
3. Verify panel displays titles correctly
4. Test with multiple component IDs
5. Test empty state (no IDs configured)

### To-dos

- [ ] Create Supabase RPC function get_storybook_component using MCP
- [ ] Create mock usage-data.json structure for development
- [ ] Add usage parameter interface to types.ts
- [ ] Modify Panel component to read componentId and display title
- [ ] Create fetch-usage-data.js script to call Infa API
- [ ] Add fetch-usage-data script to package.json
- [ ] Create .env.example with INFA_API_KEY documentation
- [ ] Update README with usage instructions and configuration